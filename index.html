<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>American Pronunciation — Firebase</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <style>
    :root { 
      --sidebar-width: 280px; 
      --sidebar-width-collapsed: 60px;
    }
    body { 
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; 
      overflow-x: hidden;
    }
    .app { 
      min-height: 100vh; 
      display: grid; 
      grid-template-columns: var(--sidebar-width) 1fr; 
      transition: grid-template-columns 0.3s ease;
    }
    .app.sidebar-collapsed {
      grid-template-columns: var(--sidebar-width-collapsed) 1fr;
    }
    .sidebar { 
      border-right: 1px solid #e9ecef; 
      transition: width 0.3s ease;
      position: relative;
    }
    .sidebar-collapsed .sidebar {
      width: var(--sidebar-width-collapsed);
    }
    .sidebar-collapsed .sidebar-content {
      display: none;
    }
    .sidebar-toggle {
      position: absolute;
      top: 10px;
      right: 10px;
      cursor: pointer;
      display: none;
    }
    .folder-item.active { 
      background: #f1f3f5; 
      border-left: 3px solid #0d6efd; 
    }
    .folder-item { 
      padding-left: calc(10px * var(--depth, 0)); 
    }
    .item-card { 
      transition: transform .06s ease; 
    }
    .item-card:hover { 
      transform: translateY(-1px); 
    }
    .img-thumb { 
      width: 48px; 
      height: 48px; 
      object-fit: cover; 
      border-radius: .5rem; 
    }
    .wave { 
      height: 48px; 
      background: repeating-linear-gradient(90deg, #e9ecef 0, #e9ecef 2px, transparent 2px, transparent 4px); 
      border-radius: .5rem; 
    }
    .search-highlight { 
      background: #fff3cd; 
      padding: 0 .2rem; 
      border-radius: .25rem; 
    }
    .pointer { 
      cursor: pointer; 
    }
    .recording-dot { 
      width: 10px; 
      height: 10px; 
      background: #dc3545; 
      border-radius: 50%; 
      display: inline-block; 
      margin-inline-end: .4rem; 
      animation: pulse 1s infinite; 
    }
    .toggle-icon { 
      width: 16px; 
      margin-right: 5px; 
    }
    @keyframes pulse { 
      0% {opacity: .3} 
      50% {opacity: 1} 
      100% {opacity: .3} 
    }
    /* Responsive Adjustments */
    @media (max-width: 768px) {
      .app {
        grid-template-columns: var(--sidebar-width-collapsed) 1fr;
      }
      .app.sidebar-expanded {
        grid-template-columns: var(--sidebar-width) 1fr;
      }
      .sidebar {
        width: var(--sidebar-width-collapsed);
      }
      .sidebar-expanded .sidebar {
        width: var(--sidebar-width);
      }
      .sidebar-content {
        display: none;
      }
      .sidebar-expanded .sidebar-content {
        display: block;
      }
      .sidebar-toggle {
        display: block;
      }
      .item-card .card-body {
        flex-direction: column;
        align-items: start;
      }
      .img-thumb {
        width: 100%;
        height: auto;
        max-width: 100px;
      }
      .modal-lg {
        --bs-modal-width: 90vw;
      }
      .modal-xl {
        --bs-modal-width: 95vw;
      }
      .input-group-sm, .btn-sm {
        font-size: 0.9rem;
      }
      #itemSearch, #folderSearch {
        width: 100% !important;
      }
      .d-flex.gap-2 {
        flex-direction: column;
        align-items: stretch;
      }
      .btn-group-sm {
        width: 100%;
        justify-content: space-between;
      }
      .btn-group-sm .btn {
        flex: 1;
      }
      .shadowing-controls {
        flex-direction: column;
        align-items: stretch;
      }
      .shadowing-controls .input-group, .shadowing-controls .btn-group {
        width: 100% !important;
        margin-bottom: 0.5rem;
      }
    }
    @media (max-width: 576px) {
      h4, h5, h6 {
        font-size: 1.2rem;
      }
      .small {
        font-size: 0.8rem;
      }
      .item-card .card-body {
        padding: 0.75rem;
      }
      .wave {
        height: 32px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Sidebar: Folders -->
    <aside class="sidebar p-3">
      <span class="sidebar-toggle bi bi-list" id="sidebarToggle"></span>
      <div class="sidebar-content">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <h5 class="mb-0">Folders</h5>
          <div class="btn-group">
            <button class="btn btn-sm btn-outline-primary" id="btnAddFolder">Add</button>
            <button class="btn btn-sm btn-outline-secondary" id="btnRenameFolder">Rename</button>
            <button class="btn btn-sm btn-outline-danger" id="btnDeleteFolder">Delete</button>
          </div>
        </div>
        <div class="mb-3">
          <input type="search" id="folderSearch" class="form-control form-control-sm" placeholder="Filter folders" />
        </div>
        <ul class="list-group" id="folderList" aria-label="Folder list"></ul>
        <hr class="my-3">
        <div class="d-grid gap-2">
          <button class="btn btn-outline-secondary btn-sm" id="btnExport">Export JSON</button>
          <label class="btn btn-outline-secondary btn-sm mb-0" for="importFile">Import JSON</label>
          <input type="file" id="importFile" accept="application/json" hidden />
          <button class="btn btn-outline-secondary btn-sm" id="btnClearAll">Clear Local Data</button>
        </div>
        <div class="text-muted small mt-3">
          <strong>Storage:</strong> Firebase<br>
          <span id="userEmail" class="d-block mt-1"></span>
          <button id="btnLogout" class="btn btn-sm btn-danger mt-2 w-100">Logout</button>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="p-3">
      <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
        <h4 class="mb-0">Items</h4>
        <div class="ms-auto d-flex gap-2">
          <div class="input-group input-group-sm" style="width: 360px;">
            <span class="input-group-text">Search</span>
            <input type="search" id="itemSearch" class="form-control" placeholder="Search in content"/>
            <button class="btn btn-outline-secondary" id="btnClearSearch">×</button>
          </div>
          <button class="btn btn-primary btn-sm" id="btnAddItem">Add Item</button>
          <button class="btn btn-outline-primary btn-sm" id="btnBulkSpeak">Play All</button>
        </div>
      </div>

      <div class="row g-3" id="itemGrid" aria-live="polite"></div>

      <div class="mt-4 p-3 border rounded-4 bg-light">
        <div class="d-flex align-items-center gap-2 mb-2">
          <h6 class="mb-0">Shadowing</h6>
          <span class="text-muted small">(Play, record, and compare basics)</span>
        </div>
        <div class="row g-3 align-items-end">
          <div class="col-md-6">
            <label class="form-label">Text</label>
            <textarea id="shadowText" class="form-control" rows="2" placeholder="Type or select text to practice..."></textarea>
          </div>
          <div class="col-md-6 shadowing-controls">
            <div class="d-flex gap-2 flex-wrap">
              <div class="input-group input-group-sm" style="width:220px;">
                <span class="input-group-text">Repeat</span>
                <input type="number" min="1" max="10" value="1" id="repeatCount" class="form-control"/>
              </div>
              <div class="input-group input-group-sm" style="width:300px;">
                <label class="input-group-text" for="voiceSelect">Voice</label>
                <select id="voiceSelect" class="form-select"></select>
              </div>
              <div class="btn-group btn-group-sm" role="group">
                <button class="btn btn-success" id="btnShadowPlay">Play</button>
                <button class="btn btn-outline-success" id="btnShadowStop">Stop</button>
              </div>
              <div class="btn-group btn-group-sm" role="group">
                <button class="btn btn-danger" id="btnRecord"><span id="recDot" class="d-none recording-dot"></span>Record</button>
                <button class="btn btn-outline-danger" id="btnStopRecord">Stop Rec</button>
                <button class="btn btn-outline-secondary" id="btnPlayBack">Playback</button>
                <button class="btn btn-outline-secondary" id="btnSaveTake">Save Take</button>
              </div>
            </div>
          </div>
        </div>
        <div class="row g-3 mt-2">
          <div class="col-md-6">
            <div class="small text-muted">System audio</div>
            <div class="wave" id="sysWave"></div>
          </div>
          <div class="col-md-6">
            <div class="small text-muted">Your recording</div>
            <div class="wave" id="userWave"></div>
          </div>
        </div>
        <div class="mt-2 small" id="compareOut"></div>
      </div>
    </main>
  </div>

  <!-- Modals -->
  <div class="modal" id="itemModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="itemModalTitle">Add item</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Text</label>
              <textarea id="itemText" class="form-control" rows="3" placeholder="Word or sentence..."></textarea>
            </div>
            <div class="col-md-6">
              <label class="form-label">Translation / Notes</label>
              <textarea id="itemNote" class="form-control" rows="3" placeholder="Optional"></textarea>
            </div>
            <div class="col-12">
              <div class="d-flex flex-wrap gap-2 align-items-end">
                <div class="input-group" style="max-width: 360px;">
                  <span class="input-group-text">Image URL</span>
                  <input type="url" id="itemImgUrl" class="form-control" placeholder="https://..." />
                </div>
                <button class="btn btn-outline-secondary" id="btnOpenImageSearch" type="button">Search Image (Unsplash)</button>
                <div class="input-group" style="max-width: 220px;">
                  <span class="input-group-text">Repeat</span>
                  <input type="number" class="form-control" id="itemRepeat" min="1" max="10" value="1" />
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" id="btnSaveItem">Save</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="folderModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="folderModalTitle">Add folder</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <label class="form-label">Folder name</label>
          <input type="text" id="folderName" class="form-control" placeholder="Enter folder name" />
          <label class="form-label mt-3">Parent folder</label>
          <select id="parentFolderSelect" class="form-select">
            <option value="">Top level</option>
          </select>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" id="btnSaveFolder">Save</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirm delete</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete? <strong>This cannot be undone.</strong></p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-danger" id="btnConfirmDelete">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="imageSearchModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Search Images (Unsplash)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="input-group mb-3">
            <span class="input-group-text">Query</span>
            <input type="text" id="imgQuery" class="form-control" placeholder="e.g., apple, happy, run" />
            <button class="btn btn-primary" id="btnDoImgSearch">Search</button>
          </div>
          <div class="row g-3" id="imgResults"></div>
          <div class="small text-muted mt-2">Requires Unsplash Access Key. See <code>UNSPLASH_ACCESS_KEY</code> in the script.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Auth Modal -->
  <div class="modal" id="authModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Login / Sign Up</h5>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" id="authEmail" class="form-control" placeholder="your@email.com">
          </div>
          <div class="mb-3">
            <label class="form-label">Password</label>
            <input type="password" id="authPassword" class="form-control" placeholder="At least 6 characters">
          </div>
          <div class="alert alert-danger d-none" id="authError"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" id="btnLogin">Login</button>
          <button class="btn btn-outline-primary" id="btnSignUp">Sign Up</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toasts -->
  <div class="position-fixed top-0 end-0 p-3" style="z-index: 1080">
    <div id="toast" class="toast align-items-center" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="toastBody">Saved</div>
        <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
  
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // ==========================
    // Firebase Configuration
    // ==========================
    // const firebaseConfig = {
    //   apiKey: "YOUR_API_KEY",
    //   authDomain: "YOUR_PROJECT.firebaseapp.com",
    //   projectId: "YOUR_PROJECT",
    //   storageBucket: "YOUR_PROJECT.appspot.com",
    //   messagingSenderId: "YOUR_SENDER_ID",
    //   appId: "YOUR_APP_ID"
    // };
    // Import the functions you need from the SDKs you need
// import { initializeApp } from "firebase/app";
// import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyC99dnKUOSuifzQtheeB-TUAZ6ACM3unJ0",
  authDomain: "gateway-english.firebaseapp.com",
  projectId: "gateway-english",
  storageBucket: "gateway-english.firebasestorage.app",
  messagingSenderId: "132452586371",
  appId: "1:132452586371:web:9a78f470377aa3d641dcb6",
  measurementId: "G-9T2SRL2LQE"
};

// Initialize Firebase
// const app = initializeApp(firebaseConfig);
// const analytics = getAnalytics(app);

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // Configuration
    // const UNSPLASH_ACCESS_KEY = ''; // Add your Unsplash API key here
    // إذا كنت تريد البحث عن الصور
const UNSPLASH_ACCESS_KEY = 'your-unsplash-access-key';

    // ==========================
    // Data Structure
    // ==========================
    const DEFAULT_DATA = {
      folders: [
        {
          id: crypto.randomUUID(),
          name: 'Basics',
          items: [
            { id: crypto.randomUUID(), text: 'Hello!', note: 'Greeting', img: '', repeat: 1 },
            { id: crypto.randomUUID(), text: 'How are you?', note: 'Small talk', img: '', repeat: 1 },
          ],
          children: [
            {
              id: crypto.randomUUID(),
              name: 'Greetings',
              items: [
                { id: crypto.randomUUID(), text: 'Good morning!', note: 'Morning greeting', img: '', repeat: 1 }
              ],
              children: []
            }
          ]
        },
        {
          id: crypto.randomUUID(),
          name: 'Food',
          items: [
            { id: crypto.randomUUID(), text: 'An apple a day.', note: 'Proverb', img: '', repeat: 1 }
          ],
          children: []
        }
      ]
    };

    let DATA = JSON.parse(JSON.stringify(DEFAULT_DATA));
    let currentFolderId = DATA.folders[0]?.id || null;
    let pendingDelete = null;
    let expandedFolders = new Set();
    let editingItemId = null;
    let mediaStream, mediaRecorder, chunks = [], lastBlob = null;

    // Utility functions
    function qs(sel, el = document) { return el.querySelector(sel); }
    function qsa(sel, el = document) { return Array.from(el.querySelectorAll(sel)); }
    function toast(msg) {
      qs('#toastBody').textContent = msg;
      const t = new bootstrap.Toast(qs('#toast'));
      t.show();
    }
    function sanitize(str) { return (str || '').toString(); }

    // ==========================
    // Authentication
    // ==========================
    function showAuthModal() {
      const modal = new bootstrap.Modal('#authModal');
      modal.show();
    }

    function hideAuthModal() {
      const modal = bootstrap.Modal.getInstance('#authModal');
      if (modal) modal.hide();
    }

    function showAuthError(message) {
      const errorEl = qs('#authError');
      errorEl.textContent = message;
      errorEl.classList.remove('d-none');
    }

    function clearAuthError() {
      qs('#authError').classList.add('d-none');
    }

    async function signUp(email, password) {
      try {
        clearAuthError();
        await auth.createUserWithEmailAndPassword(email, password);
        await initUserData();
        hideAuthModal();
        toast('Welcome! Your account has been created.');
      } catch (error) {
        showAuthError(error.message);
      }
    }

    async function login(email, password) {
      try {
        clearAuthError();
        await auth.signInWithEmailAndPassword(email, password);
        hideAuthModal();
        toast('Welcome back!');
      } catch (error) {
        showAuthError(error.message);
      }
    }

    async function logout() {
      try {
        await auth.signOut();
        toast('You have been logged out');
      } catch (error) {
        toast('Error logging out: ' + error.message);
      }
    }

    async function initUserData() {
      const user = auth.currentUser;
      if (!user) return;
      
      const doc = await db.collection('users').doc(user.uid).get();
      if (!doc.exists) {
        await db.collection('users').doc(user.uid).set(DEFAULT_DATA);
        DATA = JSON.parse(JSON.stringify(DEFAULT_DATA));
      }
    }

    // ==========================
    // Data Management
    // ==========================
    async function loadData() {
      const user = auth.currentUser;
      if (!user) return;

      try {
        const doc = await db.collection('users').doc(user.uid).get();
        DATA = doc.exists ? doc.data() : JSON.parse(JSON.stringify(DEFAULT_DATA));
        currentFolderId = DATA.folders[0]?.id || null;
        renderFolders();
        renderItems();
        updateUserInfo();
      } catch (error) {
        console.error("Error loading data:", error);
        toast('Error loading data');
      }
    }

    async function saveData() {
      const user = auth.currentUser;
      if (!user) return;

      try {
        await db.collection('users').doc(user.uid).set(DATA);
        console.log("Data saved to Firestore");
      } catch (error) {
        console.error("Error saving data:", error);
        toast('Error saving data');
      }
    }

    function updateUserInfo() {
      const user = auth.currentUser;
      if (user) {
        qs('#userEmail').textContent = user.email;
      } else {
        qs('#userEmail').textContent = 'Not logged in';
      }
    }

    // ==========================
    // Folder Management
    // ==========================
    function findFolderById(folderId, folders = DATA.folders) {
      for (const folder of folders) {
        if (folder.id === folderId) return folder;
        const sub = findFolderById(folderId, folder.children);
        if (sub) return sub;
      }
      return null;
    }

    function getAllFolders(folders = DATA.folders, result = []) {
      for (const folder of folders) {
        result.push(folder);
        getAllFolders(folder.children, result);
      }
      return result;
    }

    function renderFolders() {
      const list = qs('#folderList');
      list.innerHTML = '';
      renderFolderTree(DATA.folders, list, 0);
    }

    function renderFolderTree(folders, parentEl, depth) {
      for (const folder of folders) {
        const li = document.createElement('li');
        li.className = 'list-group-item folder-item pointer d-flex align-items-center';
        li.style.setProperty('--depth', depth);
        li.dataset.folderId = folder.id;
        
        if (folder.id === currentFolderId) {
          li.classList.add('active');
        }

        const hasChildren = folder.children && folder.children.length > 0;
        const isExpanded = expandedFolders.has(folder.id);
        
        li.innerHTML = `
          ${hasChildren ? `<i class="toggle-icon bi ${isExpanded ? 'bi-chevron-down' : 'bi-chevron-right'}" data-folder-id="${folder.id}"></i>` : '<span style="width: 16px; margin-right: 5px;"></span>'}
          <span class="flex-grow-1">${sanitize(folder.name)}</span>
          <small class="text-muted">(${folder.items?.length || 0})</small>
        `;

        li.onclick = (e) => {
          if (e.target.classList.contains('toggle-icon')) {
            if (expandedFolders.has(folder.id)) {
              expandedFolders.delete(folder.id);
            } else {
              expandedFolders.add(folder.id);
            }
            renderFolders();
          } else {
            currentFolderId = folder.id;
            renderFolders();
            renderItems();
          }
        };

        parentEl.appendChild(li);

        if (hasChildren && isExpanded) {
          renderFolderTree(folder.children, parentEl, depth + 1);
        }
      }
    }

    function addFolder() {
      qs('#folderModalTitle').textContent = 'Add folder';
      qs('#folderName').value = '';
      populateParentSelect();
      new bootstrap.Modal('#folderModal').show();
    }

    function populateParentSelect() {
      const select = qs('#parentFolderSelect');
      select.innerHTML = '<option value="">Top level</option>';
      
      function addOptions(folders, prefix = '') {
        for (const folder of folders) {
          const option = document.createElement('option');
          option.value = folder.id;
          option.textContent = prefix + folder.name;
          select.appendChild(option);
          
          if (folder.children?.length) {
            addOptions(folder.children, prefix + '  ');
          }
        }
      }
      
      addOptions(DATA.folders);
    }

    function saveFolder() {
      const name = qs('#folderName').value.trim();
      const parentId = qs('#parentFolderSelect').value;
      
      if (!name) {
        toast('Please enter a folder name');
        return;
      }

      const newFolder = {
        id: crypto.randomUUID(),
        name: name,
        items: [],
        children: []
      };

      if (parentId) {
        const parent = findFolderById(parentId);
        if (parent) {
          parent.children.push(newFolder);
        }
      } else {
        DATA.folders.push(newFolder);
      }

      saveData();
      renderFolders();
      bootstrap.Modal.getInstance('#folderModal').hide();
      toast('Folder added');
    }

    function renameFolder() {
      if (!currentFolderId) {
        toast('Please select a folder first');
        return;
      }

      const folder = findFolderById(currentFolderId);
      if (!folder) return;

      const newName = prompt('Enter new folder name:', folder.name);
      if (newName && newName.trim() !== folder.name) {
        folder.name = newName.trim();
        saveData();
        renderFolders();
        toast('Folder renamed');
      }
    }

    function deleteFolder() {
      if (!currentFolderId) {
        toast('Please select a folder first');
        return;
      }

      pendingDelete = { type: 'folder', id: currentFolderId };
      new bootstrap.Modal('#confirmModal').show();
    }

    function deleteFolderById(folderId, folders = DATA.folders) {
      for (let i = 0; i < folders.length; i++) {
        if (folders[i].id === folderId) {
          folders.splice(i, 1);
          return true;
        }
        if (deleteFolderById(folderId, folders[i].children)) {
          return true;
        }
      }
      return false;
    }

    // ==========================
    // Item Management
    // ==========================
    function getCurrentFolder() {
      return findFolderById(currentFolderId);
    }

    function renderItems() {
      const grid = qs('#itemGrid');
      const folder = getCurrentFolder();
      const searchTerm = qs('#itemSearch').value.toLowerCase();
      
      if (!folder) {
        grid.innerHTML = '<div class="col-12 text-center text-muted">Select a folder to view items</div>';
        return;
      }

      let items = folder.items || [];
      
      if (searchTerm) {
        items = items.filter(item => 
          item.text.toLowerCase().includes(searchTerm) || 
          (item.note && item.note.toLowerCase().includes(searchTerm))
        );
      }

      if (items.length === 0) {
        grid.innerHTML = `<div class="col-12 text-center text-muted">${searchTerm ? 'No items match your search' : 'No items in this folder'}</div>`;
        return;
      }

      grid.innerHTML = items.map(item => `
        <div class="col-md-6 col-lg-4">
          <div class="card item-card h-100">
            <div class="card-body d-flex align-items-center gap-3">
              <div class="flex-shrink-0">
                ${item.img ? `<img src="${item.img}" alt="" class="img-thumb" onerror="this.style.display='none'">` : `<div class="img-thumb bg-light d-flex align-items-center justify-content-center"><i class="bi bi-image text-muted"></i></div>`}
              </div>
              <div class="flex-grow-1 min-w-0">
                <h6 class="card-title mb-1">${highlightSearch(sanitize(item.text), searchTerm)}</h6>
                ${item.note ? `<p class="card-text small text-muted mb-2">${highlightSearch(sanitize(item.note), searchTerm)}</p>` : ''}
                <div class="d-flex gap-1">
                  <button class="btn btn-sm btn-outline-success" onclick="speakItem('${item.id}')" title="Speak">
                    <i class="bi bi-volume-up"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-primary" onclick="editItem('${item.id}')" title="Edit">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-danger" onclick="deleteItem('${item.id}')" title="Delete">
                    <i class="bi bi-trash"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-secondary" onclick="copyToShadowing('${item.text}')" title="Copy to Shadowing">
                    <i class="bi bi-copy"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `).join('');
    }

    function highlightSearch(text, searchTerm) {
      if (!searchTerm) return text;
      const regex = new RegExp(`(${searchTerm})`, 'gi');
      return text.replace(regex, '<span class="search-highlight">$1</span>');
    }

    function addItem() {
      editingItemId = null;
      qs('#itemModalTitle').textContent = 'Add item';
      qs('#itemText').value = '';
      qs('#itemNote').value = '';
      qs('#itemImgUrl').value = '';
      qs('#itemRepeat').value = '1';
      new bootstrap.Modal('#itemModal').show();
    }

    function editItem(itemId) {
      const folder = getCurrentFolder();
      const item = folder?.items?.find(i => i.id === itemId);
      if (!item) return;

      editingItemId = itemId;
      qs('#itemModalTitle').textContent = 'Edit item';
      qs('#itemText').value = item.text;
      qs('#itemNote').value = item.note || '';
      qs('#itemImgUrl').value = item.img || '';
      qs('#itemRepeat').value = item.repeat || 1;
      new bootstrap.Modal('#itemModal').show();
    }

    function saveItem() {
      const text = qs('#itemText').value.trim();
      const note = qs('#itemNote').value.trim();
      const img = qs('#itemImgUrl').value.trim();
      const repeat = parseInt(qs('#itemRepeat').value) || 1;

      if (!text) {
        toast('Please enter some text');
        return;
      }

      const folder = getCurrentFolder();
      if (!folder) {
        toast('Please select a folder first');
        return;
      }

      if (editingItemId) {
        const item = folder.items.find(i => i.id === editingItemId);
        if (item) {
          item.text = text;
          item.note = note;
          item.img = img;
          item.repeat = repeat;
        }
      } else {
        const newItem = {
          id: crypto.randomUUID(),
          text: text,
          note: note,
          img: img,
          repeat: repeat
        };
        folder.items.push(newItem);
      }

      saveData();
      renderItems();
      renderFolders();
      bootstrap.Modal.getInstance('#itemModal').hide();
      toast(editingItemId ? 'Item updated' : 'Item added');
    }

    function deleteItem(itemId) {
      pendingDelete = { type: 'item', id: itemId };
      new bootstrap.Modal('#confirmModal').show();
    }

    function copyToShadowing(text) {
      qs('#shadowText').value = text;
      toast('Text copied to shadowing area');
    }

    // ==========================
    // Text-to-Speech
    // ==========================
    let currentSpeech = null;

    function speakItem(itemId) {
      const folder = getCurrentFolder();
      const item = folder?.items?.find(i => i.id === itemId);
      if (!item) return;

      speakText(item.text, item.repeat || 1);
    }

    function speakText(text, repeat = 1) {
      if (currentSpeech) {
        speechSynthesis.cancel();
        currentSpeech = null;
      }

      const utterance = new SpeechSynthesisUtterance(text);
      const selectedVoice = qs('#voiceSelect').value;
      
      if (selectedVoice) {
        const voices = speechSynthesis.getVoices();
        const voice = voices.find(v => v.name === selectedVoice);
        if (voice) utterance.voice = voice;
      }

      utterance.rate = 0.8;
      utterance.pitch = 1;

      let repeatCount = 0;
      utterance.onend = () => {
        repeatCount++;
        if (repeatCount < repeat) {
          setTimeout(() => speechSynthesis.speak(utterance), 500);
        } else {
          currentSpeech = null;
        }
      };

      currentSpeech = utterance;
      speechSynthesis.speak(utterance);
    }

    function stopSpeaking() {
      if (currentSpeech) {
        speechSynthesis.cancel();
        currentSpeech = null;
      }
    }

    function bulkSpeak() {
      const folder = getCurrentFolder();
      if (!folder || !folder.items?.length) {
        toast('No items to speak');
        return;
      }

      let index = 0;
      function speakNext() {
        if (index >= folder.items.length) return;
        
        const item = folder.items[index];
        const utterance = new SpeechSynthesisUtterance(item.text);
        
        const selectedVoice = qs('#voiceSelect').value;
        if (selectedVoice) {
          const voices = speechSynthesis.getVoices();
          const voice = voices.find(v => v.name === selectedVoice);
          if (voice) utterance.voice = voice;
        }

        utterance.rate = 0.8;
        utterance.onend = () => {
          index++;
          setTimeout(speakNext, 1000);
        };

        speechSynthesis.speak(utterance);
      }

      speakNext();
    }

    function populateVoices() {
      const select = qs('#voiceSelect');
      const voices = speechSynthesis.getVoices();
      
      select.innerHTML = '';
      
      const englishVoices = voices.filter(voice => voice.lang.startsWith('en'));
      
      if (englishVoices.length === 0) {
        select.innerHTML = '<option>No English voices available</option>';
        return;
      }

      for (const voice of englishVoices) {
        const option = document.createElement('option');
        option.value = voice.name;
        option.textContent = `${voice.name} (${voice.lang})`;
        select.appendChild(option);
      }

      // Try to select a US English voice by default
      const usVoice = englishVoices.find(v => v.lang === 'en-US');
      if (usVoice) {
        select.value = usVoice.name;
      }
    }

    // ==========================
    // Shadowing & Recording
    // ==========================
    function shadowPlay() {
      const text = qs('#shadowText').value.trim();
      const repeat = parseInt(qs('#repeatCount').value) || 1;
      
      if (!text) {
        toast('Please enter text to practice');
        return;
      }

      speakText(text, repeat);
    }

    async function startRecording() {
      try {
        mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(mediaStream);
        chunks = [];

        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
            chunks.push(event.data);
          }
        };

        mediaRecorder.onstop = () => {
          lastBlob = new Blob(chunks, { type: 'audio/wav' });
          qs('#compareOut').innerHTML = '<span class="text-success">Recording saved. Click Playback to listen.</span>';
        };

        mediaRecorder.start();
        qs('#recDot').classList.remove('d-none');
        toast('Recording started');
      } catch (error) {
        toast('Error accessing microphone: ' + error.message);
      }
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        qs('#recDot').classList.add('d-none');
        toast('Recording stopped');
      }
      if (mediaStream) {
        mediaStream.getTracks().forEach(track => track.stop());
      }
    }

    function playbackRecording() {
      if (lastBlob) {
        const audio = new Audio(URL.createObjectURL(lastBlob));
        audio.play();
      } else {
        toast('No recording available');
      }
    }

    function saveTake() {
      if (lastBlob) {
        const text = qs('#shadowText').value.trim();
        const fileName = `recording_${Date.now()}.wav`;
        
        // In a full implementation, you would save to Firebase Storage
        toast(`Recording would be saved as: ${fileName}`);
        
        // For demo purposes, we'll just download the file
        const url = URL.createObjectURL(lastBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        a.click();
      } else {
        toast('No recording to save');
      }
    }

    // ==========================
    // Image Search (Unsplash)
    // ==========================
    function openImageSearch() {
      qs('#imgQuery').value = '';
      qs('#imgResults').innerHTML = '';
      new bootstrap.Modal('#imageSearchModal').show();
    }

    async function searchImages() {
      const query = qs('#imgQuery').value.trim();
      if (!query) {
        toast('Please enter a search term');
        return;
      }

      if (!UNSPLASH_ACCESS_KEY) {
        toast('Unsplash API key not configured');
        return;
      }

      try {
        const response = await fetch(`https://api.unsplash.com/search/photos?query=${encodeURIComponent(query)}&per_page=12`, {
          headers: {
            'Authorization': `Client-ID ${UNSPLASH_ACCESS_KEY}`
          }
        });

        const data = await response.json();
        const results = qs('#imgResults');
        
        if (data.results && data.results.length > 0) {
          results.innerHTML = data.results.map(photo => `
            <div class="col-md-3 col-sm-6">
              <div class="card">
                <img src="${photo.urls.small}" class="card-img-top" style="height: 200px; object-fit: cover;" alt="${photo.alt_description || 'Image'}">
                <div class="card-body p-2">
                  <button class="btn btn-primary btn-sm w-100" onclick="selectImage('${photo.urls.regular}')">
                    Select
                  </button>
                </div>
              </div>
            </div>
          `).join('');
        } else {
          results.innerHTML = '<div class="col-12 text-center text-muted">No images found</div>';
        }
      } catch (error) {
        toast('Error searching images: ' + error.message);
      }
    }

    function selectImage(imageUrl) {
      qs('#itemImgUrl').value = imageUrl;
      bootstrap.Modal.getInstance('#imageSearchModal').hide();
      toast('Image selected');
    }

    // ==========================
    // Import/Export
    // ==========================
    function exportData() {
      const dataStr = JSON.stringify(DATA, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `pronunciation_data_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      
      URL.revokeObjectURL(url);
      toast('Data exported');
    }

    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const importedData = JSON.parse(e.target.result);
          if (importedData.folders && Array.isArray(importedData.folders)) {
            DATA = importedData;
            currentFolderId = DATA.folders[0]?.id || null;
            saveData();
            renderFolders();
            renderItems();
            toast('Data imported successfully');
          } else {
            toast('Invalid file format');
          }
        } catch (error) {
          toast('Error importing data: ' + error.message);
        }
      };
      reader.readAsText(file);
      
      // Reset the input
      event.target.value = '';
    }

    function clearAllData() {
      if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
        DATA = JSON.parse(JSON.stringify(DEFAULT_DATA));
        currentFolderId = DATA.folders[0]?.id || null;
        saveData();
        renderFolders();
        renderItems();
        toast('All data cleared');
      }
    }

    // ==========================
    // Event Listeners
    // ==========================
    document.addEventListener('DOMContentLoaded', () => {
      // Auth listeners
      qs('#btnLogin').onclick = () => {
        const email = qs('#authEmail').value;
        const password = qs('#authPassword').value;
        login(email, password);
      };

      qs('#btnSignUp').onclick = () => {
        const email = qs('#authEmail').value;
        const password = qs('#authPassword').value;
        signUp(email, password);
      };

      qs('#btnLogout').onclick = logout;

      // Auth state observer
      auth.onAuthStateChanged(user => {
        if (user) {
          loadData();
          updateUserInfo();
        } else {
          showAuthModal();
          DATA = JSON.parse(JSON.stringify(DEFAULT_DATA));
          currentFolderId = DATA.folders[0]?.id || null;
          renderFolders();
          renderItems();
          updateUserInfo();
        }
      });

      // Folder management
      qs('#btnAddFolder').onclick = addFolder;
      qs('#btnRenameFolder').onclick = renameFolder;
      qs('#btnDeleteFolder').onclick = deleteFolder;
      qs('#btnSaveFolder').onclick = saveFolder;

      // Item management
      qs('#btnAddItem').onclick = addItem;
      qs('#btnSaveItem').onclick = saveItem;
      qs('#btnBulkSpeak').onclick = bulkSpeak;

      // Search
      qs('#itemSearch').oninput = renderItems;
      qs('#btnClearSearch').onclick = () => {
        qs('#itemSearch').value = '';
        renderItems();
      };

      qs('#folderSearch').oninput = (e) => {
        const term = e.target.value.toLowerCase();
        qsa('.folder-item').forEach(item => {
          const text = item.textContent.toLowerCase();
          item.style.display = text.includes(term) ? '' : 'none';
        });
      };

      // Shadowing
      qs('#btnShadowPlay').onclick = shadowPlay;
      qs('#btnShadowStop').onclick = stopSpeaking;
      qs('#btnRecord').onclick = startRecording;
      qs('#btnStopRecord').onclick = stopRecording;
      qs('#btnPlayBack').onclick = playbackRecording;
      qs('#btnSaveTake').onclick = saveTake;

      // Image search
      qs('#btnOpenImageSearch').onclick = openImageSearch;
      qs('#btnDoImgSearch').onclick = searchImages;
      qs('#imgQuery').onkeypress = (e) => {
        if (e.key === 'Enter') searchImages();
      };

      // Import/Export
      qs('#btnExport').onclick = exportData;
      qs('#importFile').onchange = importData;
      qs('#btnClearAll').onclick = clearAllData;

      // Confirm delete
      qs('#btnConfirmDelete').onclick = () => {
        if (pendingDelete) {
          if (pendingDelete.type === 'folder') {
            deleteFolderById(pendingDelete.id);
            if (currentFolderId === pendingDelete.id) {
              currentFolderId = DATA.folders[0]?.id || null;
            }
            renderFolders();
            renderItems();
            toast('Folder deleted');
          } else if (pendingDelete.type === 'item') {
            const folder = getCurrentFolder();
            if (folder) {
              folder.items = folder.items.filter(item => item.id !== pendingDelete.id);
              renderItems();
              renderFolders();
              toast('Item deleted');
            }
          }
          saveData();
        }
        bootstrap.Modal.getInstance('#confirmModal').hide();
        pendingDelete = null;
      };

      // Sidebar toggle
      qs('#sidebarToggle').onclick = () => {
        qs('.app').classList.toggle('sidebar-collapsed');
      };

      // Initialize voices
      populateVoices();
      
      // Repopulate voices when they change (some browsers load them asynchronously)
      speechSynthesis.onvoiceschanged = populateVoices;

      // Initialize UI
      renderFolders();
      renderItems();
    });

    // Make functions available globally for onclick handlers
    window.speakItem = speakItem;
    window.editItem = editItem;
    window.deleteItem = deleteItem;
    window.copyToShadowing = copyToShadowing;
    window.selectImage = selectImage;
  </script>
</body>
</html>
